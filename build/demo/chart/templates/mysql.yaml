{{- if eq .Values.database.mode "local" }}
apiVersion: v1
kind: Service
metadata:
  name: {{ .Values.database.local.connection.host }}
  labels:
    app.kubernetes.io/name: mysql
spec:
  ports:
    - port: 3306
  selector:
    app.kubernetes.io/name: mysql
  clusterIP: None
{{- end }}
---
{{- if eq .Values.database.mode "local" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  labels:
    app.kubernetes.io/name: mysql
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mysql
      annotations:
        date: {{ now }} # RollingRestart workaround. https://github.com/kubernetes/kubernetes/issues/13488
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        args:
        - --ignore-db-dir=lost+found
        - --default-storage-engine=InnoDB
        - --character-set-server=utf8
        - --collation-server=utf8_bin
        - --lower-case-table_names=1
        - --skip-external-locking
        - --key_buffer_size=256M
        - --max_allowed_packet=32M
        - --table_open_cache=256
        - --sort_buffer_size=16M
        - --read_buffer_size=16M
        - --read_rnd_buffer_size=16M
        - --myisam_sort_buffer_size=64M
        - --thread_cache_size=8
        - --query_cache_size=16M
        - --interactive_timeout=86400
        - --wait_timeout=86400
        - --innodb_flush_log_at_trx_commit=1
        - --innodb_lock_wait_timeout=50
        - --innodb_thread_concurrency=8
        - --innodb_buffer_pool_size=1G
        - --innodb_read_io_threads=12
        - --innodb_write_io_threads=12
        - --innodb_io_capacity=300
        - --innodb_log_file_size=128M
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: xxx
        - name: MYSQL_DATABASE
          value: {{ .Values.database.local.connection.name }}
        - name: MYSQL_USER
          value: {{ .Values.database.local.connection.user }}
        - name: MYSQL_PASSWORD
          value: {{ .Values.database.local.connection.password }}
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: db-ps
          mountPath: /var/lib/mysql
        resources:
          requests:
            memory: 1G
            cpu: 300m
          limits:
            memory: 3G
            cpu: 1000m
        livenessProbe:
          exec:
            command: ['sh', '-c', 'mysqladmin ping -u root -pxxx']
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            {{- with .Values.database.local.connection }}
            - mysqlshow -u{{ .user }} -p{{ .password }} {{ .name }} > /dev/null
            {{- end }}
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: db-ps
        emptyDir:
          medium: Memory
{{- end }}
